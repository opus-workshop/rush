id: '63'
title: Audit and fix critical production panics
status: open
priority: 1
created_at: 2026-01-30T18:49:24.584903Z
updated_at: 2026-01-30T18:49:24.584903Z
description: |-
  Audit and fix critical production panics

  ## Changes Made

  ### src/runtime/mod.rs
  - Replaced `panic!("Cannot create undo manager")` in `undo_manager_mut()` with a graceful fallback chain:
    1. Try creating UndoManager with home directory (normal path)
    2. If that fails, try with temp directory as fallback
    3. If both fail, create a disabled UndoManager (no-op, no panic)

  ### src/undo/mod.rs
  - Added `UndoManager::new_disabled()` constructor that creates an UndoManager with `enabled: false` and a dummy path. Used as the last-resort fallback when filesystem access is unavailable.

  ### src/daemon/worker_pool.rs
  - Replaced all 6 `.lock().unwrap()` calls on Mutex with `.lock().unwrap_or_else(|e| e.into_inner())` to recover from mutex poison instead of panicking. Each instance logs a warning via eprintln.
  - Affected methods: `dispatch_request`, `dispatch_to_worker`, `process_next_queued_request`, `stats`

  ### src/correction/mod.rs
  - No changes needed: all 6 `current_dir().unwrap()` calls are inside `#[cfg(test)] mod tests` blocks, which is acceptable per the acceptance criteria.

  ## Verification
  - `cargo build` succeeds with no new warnings
  - `cargo test --lib` passes 631/635 tests (same 4 pre-existing failures before and after changes)
  - `cargo clippy -- -D warnings` shows no new warnings from modified files (all clippy errors are pre-existing)
