id: '40'
title: 'AI-008: Structured error responses with error types'
status: open
priority: 2
created_at: 2026-01-30T18:49:24.456821Z
updated_at: 2026-01-30T18:49:24.456821Z
description: "As an AI coding agent, I need machine-readable error types so I can respond intelligently to failures instead of parsing error messages.\n\n## Priority: P1 - HIGH\nError handling is critical for AI agents. Exit codes alone are insufficient - agents need to know *why* something failed to take appropriate action.\n\n## Acceptance Criteria\n- [ ] Define standard error type taxonomy\n- [ ] All builtins return typed errors\n- [ ] `RUSH_ERROR_FORMAT=json` environment variable\n- [ ] Errors include: type, message, context, exit_code\n- [ ] `--error-json` flag for command-level override\n- [ ] Backwards compatible: default is text errors\n- [ ] Document all error types\n- [ ] cargo test passes\n- [ ] cargo build --release succeeds\n- [ ] cargo clippy -- -D warnings passes\n\n## Use Cases\n```bash\n# AI agent: Enable JSON errors\nexport RUSH_ERROR_FORMAT=json\n\n# AI agent: Handle git errors intelligently\ngit_status --json 2> error.json\nif [ $? -ne 0 ]; then\n  error_type=$(json_get '.error.type' error.json)\n  case $error_type in\n    \"not_a_git_repo\")\n      echo \"Initializing git repo...\"\n      git init\n      ;;\n    \"permission_denied\")\n      echo \"Need sudo access\"\n      ;;\n    *)\n      echo \"Unknown error: $error_type\"\n      ;;\n  esac\nfi\n\n# Error format example:\n# {\n#   \"error\": {\n#     \"type\": \"not_a_git_repo\",\n#     \"category\": \"git\",\n#     \"message\": \"fatal: not a git repository\",\n#     \"context\": {\n#       \"cwd\": \"/tmp/foo\",\n#       \"command\": \"git_status\"\n#     },\n#     \"exit_code\": 128,\n#     \"suggestion\": \"Run 'git init' to create a new repository\"\n#   }\n# }\n```\n\n## Error Type Taxonomy\n\n### Git Errors\n- `not_a_git_repo`: Not in a git repository\n- `no_upstream`: Branch has no upstream\n- `merge_conflict`: Merge conflict in progress\n- `detached_head`: In detached HEAD state\n- `git_command_failed`: Generic git error\n\n### File Errors\n- `file_not_found`: File doesn't exist\n- `permission_denied`: Insufficient permissions\n- `is_a_directory`: Expected file, got directory\n- `not_a_directory`: Expected directory, got file\n- `disk_full`: No space left on device\n\n### Network Errors (for fetch)\n- `network_unreachable`: No network connection\n- `dns_failed`: DNS resolution failed\n- `connection_timeout`: Request timed out\n- `connection_refused`: Server refused connection\n- `http_error`: HTTP error (4xx, 5xx)\n\n### Parse Errors\n- `invalid_json`: JSON parsing failed\n- `invalid_syntax`: Command syntax error\n- `invalid_argument`: Invalid argument value\n\n### System Errors\n- `command_not_found`: Command doesn't exist\n- `killed_by_signal`: Process terminated by signal\n- `resource_exhausted`: Out of memory/resources\n\n## Technical Implementation\n1. **Create src/error.rs**\n   ```rust\n   #[derive(Debug, Clone, Serialize)]\n   pub struct RushError {\n       pub error_type: ErrorType,\n       pub category: ErrorCategory,\n       pub message: String,\n       pub context: HashMap<String, Value>,\n       pub exit_code: i32,\n       pub suggestion: Option<String>,\n   }\n   \n   #[derive(Debug, Clone, Serialize)]\n   #[serde(rename_all = \"snake_case\")]\n   pub enum ErrorType {\n       // Git\n       NotAGitRepo,\n       NoUpstream,\n       MergeConflict,\n       // File\n       FileNotFound,\n       PermissionDenied,\n       // Network\n       NetworkUnreachable,\n       ConnectionTimeout,\n       HttpError,\n       // Parse\n       InvalidJson,\n       InvalidSyntax,\n       // System\n       CommandNotFound,\n       // ... etc\n   }\n      \n   #[derive(Debug, Clone, Serialize)]\n   #[serde(rename_all = \"lowercase\")]\n   pub enum ErrorCategory {\n       Git,\n       File,\n       Network,\n       Parse,\n       System,\n   }\n   ```\n\n2. **Update ExecutionResult**\n   ```rust\n   pub struct ExecutionResult {\n       pub stdout: String,\n       pub stderr: String,\n       pub exit_code: i32,\n       pub error: Option<RushError>,  // NEW\n   }\n   \n   impl ExecutionResult {\n       pub fn error_typed(error: RushError) -> Self {\n           let stderr = if should_output_json_errors() {\n               serde_json::to_string(&error).unwrap()\n           } else {\n               error.message.clone()\n           };\n           \n           Self {\n               stdout: String::new(),\n               stderr,\n               exit_code: error.exit_code,\n               error: Some(error),\n           }\n       }\n   }\n   ```\n\n3. **Environment Variable Check**\n   ```rust\n   fn should_output_json_errors() -> bool {\n       std::env::var(\"RUSH_ERROR_FORMAT\")\n           .map(|v| v == \"json\")\n           .unwrap_or(false)\n   }\n   ```\n\n4. **Update All Builtins**\n   - Convert string errors to RushError\n   - Add context (cwd, args, etc.)\n   - Add suggestions where helpful\n   - Example:\n     ```rust\n     // Old:\n     return Ok(ExecutionResult::error(\n         \"fatal: not a git repository\\n\".to_string()\n     ));\n     \n     // New:\n     return Ok(ExecutionResult::error_typed(\n         RushError {\n             error_type: ErrorType::NotAGitRepo,\n             category: ErrorCategory::Git,\n             message: \"fatal: not a git repository\".to_string(),\n             context: hashmap!{\n                 \"cwd\" => json!(runtime.get_cwd()),\n             },\n             exit_code: 128,\n             suggestion: Some(\"Run 'git init' to create a new repository\".to_string()),\n         }\n     ));\n     ```\n\n## Migration Strategy\n1. Add RushError infrastructure (non-breaking)\n2. Update one builtin as example (git_status)\n3. Update remaining builtins incrementally\n4. Ensure backwards compatibility (text by default)\n\n## Testing Strategy\n- Unit tests: error type serialization\n- Integration tests:\n  - Default text errors (backwards compat)\n  - JSON errors with env var\n  - All error types represented\n  - Context includes expected fields\n- Error catalog test: ensure all documented errors exist\n\n## Documentation\n- Create docs/ERROR_HANDLING.md:\n  - Complete error type reference\n  - Examples for each error\n  - AI agent error handling patterns\n  - Migration guide\n- Update builtin docs with error types\n- JSON schema for error format\n\n## Dependencies\n- serde_json (already in use)\n- No new crates needed\n\n## Estimated Effort\n50-60k tokens:\n- Error infrastructure: 15k\n- Update all builtins: 20k\n- Tests: 15k\n- Documentation: 10k"
labels:
- ai-agents
- error-handling
- infrastructure
- p1
