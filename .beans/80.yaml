id: '80'
title: 'POSIX-002: Re-enable and test return builtin'
status: open
priority: 1
created_at: 2026-01-30T18:49:24.688799Z
updated_at: 2026-01-30T18:49:24.688799Z
description: |-
  Re-enable the `return` builtin for returning from shell functions with an exit code.

  ## Context
  The `return` builtin exists at `src/builtins/return_builtin.rs` but is commented out. It's critical for function control flow.

  ## Acceptance Criteria
  - Uncomment `return_builtin` module in src/builtins/mod.rs
  - Make module public so executor can access ReturnSignal
  - Uncomment return builtin registration
  - Test basic return: `fn foo() { return 42 }; foo; echo $?` â†’ 42
  - Test return without argument (should use $? from last command)
  - Test return from sourced file (. script.sh)
  - Test that return fails when not in function/sourced file
  - Verify ReturnSignal is properly caught in executor
  - Add integration tests
  - Update help text

  ## POSIX Requirements
  - Exit from shell function with specified exit code
  - Default exit code is $? if not specified
  - Error if called outside function or sourced script
  - Exit code 0-255

  ## Files to Modify
  - src/builtins/mod.rs (uncomment, make public)
  - src/builtins/return_builtin.rs (verify implementation)
  - src/executor/mod.rs (verify ReturnSignal handling)
  - src/builtins/mod.rs builtin_source (uncomment return handling)
  - tests/function_tests.rs or similar (add tests)

  ## Estimated Effort
  35-45k tokens (re-enable, fix integration, add tests)
verify: cargo build --release && cargo test && cargo clippy -- -D warnings
labels:
- builtin
- critical
- functions
- posix
