id: '52'
title: 'STABILITY-005: Exit Code Propagation'
status: open
priority: 1
created_at: 2026-01-30T18:49:24.522919Z
updated_at: 2026-01-30T18:49:24.522919Z
description: |-
  As a shell scripter, I need proper exit code handling so that error detection and conditional execution work correctly.

  ## Priority: P0 - BLOCKING
  Essential for error handling in scripts.

  ## Problem
  - Exit codes not properly propagated through pipelines
  - No $? variable support
  - Scripts using `set -e` or `||` fail

  ## Acceptance Criteria
  - [ ] $? variable contains last exit code
  - [ ] Pipeline exit code is last command (default)
  - [ ] Pipeline exit code is first failure (with set -o pipefail)
  - [ ] `command && next` only runs if success
  - [ ] `command || fallback` only runs if failure
  - [ ] Exit codes work with builtins
  - [ ] Exit codes work with external commands
  - [ ] cargo test passes (all tests including exit code tests)
  - [ ] cargo build --release succeeds
  - [ ] cargo clippy -- -D warnings passes

  ## Technical Implementation
  ```rust
  // In runtime/mod.rs
  pub fn set_last_exit_code(&mut self, code: i32) {
      self.set_variable("?".to_string(), code.to_string());
  }

  pub fn get_last_exit_code(&self) -> i32 {
      self.get_variable("?")
          .and_then(|s| s.parse().ok())
          .unwrap_or(0)
  }
  ```

  ## Files to Modify
  - src/runtime/mod.rs - Add $? special variable
  - src/executor/pipeline.rs - Track exit codes through pipeline
  - src/executor/mod.rs - Update last exit code after each command
  - src/parser/mod.rs - Parse && and || operators

  ## Testing
  - Test $? variable after success and failure
  - Test pipeline exit codes
  - Test && conditional execution
  - Test || conditional execution
  - Test mixed conditions

  ## Estimated Effort: 1 day
labels:
- critical
- exit-codes
- p0
- rush
- stability
