id: '36'
title: 'AI-004: JSON query and manipulation builtins'
status: open
priority: 2
created_at: 2026-01-30T18:49:24.436771Z
updated_at: 2026-01-30T18:49:24.436771Z
description: "As an AI coding agent, I need native JSON parsing and querying so I don't have to spawn jq for every JSON operation.\n\n## Priority: P1 - HIGH\nAI agents constantly work with JSON (API responses, config files, structured command output). Spawning jq adds 10-50ms overhead per call.\n\n## Acceptance Criteria\n- [ ] `json_get` builtin: extract values from JSON\n- [ ] `json_set` builtin: modify JSON values\n- [ ] `json_query` builtin: JSONPath or jq-like queries\n- [ ] Pipe support: `cat file.json | json_get '.user.name'`\n- [ ] File support: `json_get '.data' file.json`\n- [ ] Array indexing: `json_get '.[0].name'`\n- [ ] Multiple queries: `json_get '.name' '.email' '.age'`\n- [ ] Error handling: clear messages for invalid JSON/paths\n- [ ] Performance: <1ms for typical queries (<100KB JSON)\n- [ ] cargo test passes with extensive tests\n- [ ] cargo build --release succeeds\n- [ ] cargo clippy -- -D warnings passes\n\n## Use Cases\n```bash\n# AI agent: Extract value from API response\ncurl -s api.example.com/user | json_get '.name'\n# \"Alice\"\n\n# AI agent: Navigate nested structures\necho '{\"user\":{\"profile\":{\"age\":30}}}' | json_get '.user.profile.age'\n# 30\n\n# AI agent: Array operations\necho '[{\"name\":\"Alice\"},{\"name\":\"Bob\"}]' | json_get '.[].name'\n# Alice\n# Bob\n\n# AI agent: Multiple fields\ngit_status --json | json_get '.branch' '.ahead' '.behind'\n# feature/auth\n# 2\n# 0\n\n# AI agent: Modify JSON\necho '{\"count\":5}' | json_set '.count' 10\n# {\"count\":10}\n\n# AI agent: Query with filter\njson_query '.files[] | select(.status == \"modified\")' changes.json\n```\n\n## Technical Implementation\n1. **Create src/builtins/json.rs**\n   - Three main functions: json_get, json_set, json_query\n   - Use serde_json for parsing\n   - Use serde_json::Value for manipulation\n   - Consider jsonpath_lib or similar for path queries\n\n2. **Query Syntax**\n   Start simple, expand as needed:\n   - `.field` - get field\n   - `.field.nested` - nested access\n   - `.[0]` - array index\n   - `.[]` - array iteration\n   - Later: filters, functions (like jq)\n\n3. **Data Flow**\n   ```rust\n   // Input sources\n   enum JsonSource {\n       Stdin(String),\n       File(PathBuf),\n       Argument(String),\n   }\n   \n   // Parse -> Query -> Output\n   fn json_get(path: &str, source: JsonSource) -> Result<Value> {\n       let json: Value = parse_source(source)?;\n       let result = query_path(&json, path)?;\n       Ok(result)\n   }\n   ```\n\n4. **Output Formats**\n   - Raw value (no quotes for primitives)\n   - JSON (for objects/arrays)\n   - `--raw` flag for unquoted strings\n   - `--compact` vs `--pretty` for objects\n\n5. **Error Handling**\n   - Invalid JSON: show line/column\n   - Invalid path: show where it failed\n   - Type errors: \"expected array, got object\"\n\n## Performance Optimization\n- Lazy parsing (don't parse if not needed)\n- Streaming for large files (consider json-stream)\n- Cache parsed JSON for multiple queries\n- Benchmark vs jq\n\n## Testing Strategy\n- Unit tests:\n  - Path parsing\n  - Query execution\n  - Edge cases (null, empty, nested)\n- Integration tests:\n  - Pipe input\n  - File input\n  - Multiple queries\n  - Error cases\n- Performance tests:\n  - Small JSON (<1KB): <0.1ms\n  - Medium JSON (100KB): <1ms\n  - Large JSON (10MB): <50ms\n- Comparison: Rush vs jq on same queries\n\n## Documentation\n- Create docs/JSON_BUILTINS.md:\n  - All query syntax\n  - Examples for AI agents\n  - Performance guide\n  - Migration from jq\n- Add to README examples\n- Inline help for each builtin\n\n## Future Extensions (not in this bead)\n- `json_merge`: combine multiple JSON files\n- `json_validate`: schema validation\n- `json_format`: pretty-print\n- Full jq compatibility layer\n\n## Dependencies\n- serde_json (already in use)\n- Consider: jsonpath_lib, jq-rs, or implement simple path parser\n\n## Estimated Effort\n50-60k tokens:\n- Implementation (3 builtins): 25k\n- Path query parser: 10k\n- Tests: 15k\n- Documentation: 10k"
labels:
- ai-agents
- builtin
- json
- p1
verify: 'cargo build --release && cargo test && ./target/release/rush -c "echo hello" | head -1'
