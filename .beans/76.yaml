id: '76'
title: 'POSIX-015: Implement special variables'
status: open
priority: 1
created_at: 2026-01-30T18:49:24.664223Z
updated_at: 2026-01-30T18:49:24.664223Z
description: |-
  Implement POSIX special variables: $$, $!, $-, $_

  ## Context
  Currently only $? (exit code) is implemented. Need $$, $!, $-, $_.

  ## Acceptance Criteria
  - Implement $$ (current shell PID)
  - Implement $! (PID of last background job)
  - Implement $- (current shell options as flags: e, u, x, etc.)
  - Implement $_ (last argument of previous command)
  - Test $$ returns consistent PID
  - Test $! after background job: `sleep 10 &; echo $!`
  - Test $! is empty when no background jobs
  - Test $- reflects current set options: `set -e; echo $-` contains 'e'
  - Test $_ captures last arg: `echo foo bar; echo $_` â†’ bar
  - Add integration tests
  - Document variables

  ## POSIX Requirements
  - $$: Process ID of the shell
  - $!: Process ID of last background command
  - $-: Current option flags (as set by set command)
  - $_: Last argument of previous command (not strictly POSIX but common)

  ## Files to Modify
  - src/runtime/mod.rs (add tracking for last_bg_pid, last_arg)
  - src/executor/mod.rs (update last_arg after commands)
  - src/executor/mod.rs variable expansion (expand $$, $!, $-, $_)
  - src/jobs/mod.rs (update last_bg_pid when starting background jobs)
  - tests/special_variables_tests.rs (add tests)

  ## Estimated Effort
  40-50k tokens (implement tracking, wire up expansion, add tests)
labels:
- critical
- posix
- variables
