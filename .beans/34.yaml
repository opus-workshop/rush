id: '34'
title: 'AI-002: Structured git diff with JSON output'
status: open
priority: 1
created_at: 2026-01-30T18:49:24.426909Z
updated_at: 2026-01-30T18:49:24.426909Z
description: "As an AI coding agent, I need git diff to return structured JSON so I can analyze code changes programmatically and generate smart commit messages.\n\n## Priority: P0 - CRITICAL\nGit diff is the #1 most-called git command by AI agents - used for commit message generation, code review, change analysis.\n\n## Acceptance Criteria\n- [ ] `git_diff` builtin command implemented\n- [ ] Human-readable unified diff by default\n- [ ] `git_diff --json` returns structured JSON\n- [ ] JSON includes: files, hunks, line changes, stats\n- [ ] `git_diff --json --staged` for staged changes\n- [ ] `git_diff --json HEAD~1..HEAD` commit ranges\n- [ ] `git_diff --json --stat` summary statistics only\n- [ ] `git_diff --json file.txt` specific file diff\n- [ ] Performance: <10ms for typical diffs (<1000 lines)\n- [ ] Handles binary files gracefully\n- [ ] cargo test passes with integration tests\n- [ ] cargo build --release succeeds  \n- [ ] cargo clippy -- -D warnings passes\n\n## Use Cases\n```bash\n# AI agent: Analyze unstaged changes for commit message\ngit_diff --json\n# Returns:\n# {\n#   \"files\": [\n#     {\n#       \"path\": \"src/auth.rs\",\n#       \"status\": \"modified\",\n#       \"additions\": 15,\n#       \"deletions\": 3,\n#       \"hunks\": [\n#         {\n#           \"old_start\": 42,\n#           \"old_lines\": 5,\n#           \"new_start\": 42,\n#           \"new_lines\": 10,\n#           \"header\": \"@@ -42,5 +42,10 @@ impl Auth {\",\n#           \"changes\": [\n#             {\"type\": \"context\", \"line\": \"fn login() {\"},\n#             {\"type\": \"delete\", \"line\": \"    // TODO: implement\"},\n#             {\"type\": \"add\", \"line\": \"    let token = generate_token();\"},\n#             {\"type\": \"add\", \"line\": \"    validate_token(token)\"}\n#           ]\n#         }\n#       ]\n#     }\n#   ],\n#   \"summary\": {\n#     \"files_changed\": 1,\n#     \"insertions\": 15,\n#     \"deletions\": 3\n#   }\n# }\n\n# AI agent: Just get summary stats\ngit_diff --json --stat\n# {\"files_changed\": 3, \"insertions\": 45, \"deletions\": 12}\n\n# AI agent: Staged changes for commit message\ngit_diff --json --staged\n\n# Human: normal diff\ngit_diff src/auth.rs\n```\n\n## Technical Implementation\n1. **Create src/builtins/git_diff.rs**\n   - Use git2-rs Diff API\n   - Parse flags: --json, --staged, --stat, paths, ranges\n   - Handle both working tree and staged diffs\n\n2. **Data Structures**\n   ```rust\n   #[derive(Serialize)]\n   struct DiffOutput {\n       files: Vec<FileDiff>,\n       summary: DiffSummary,\n   }\n   \n   #[derive(Serialize)]\n   struct FileDiff {\n       path: String,\n       old_path: Option<String>,  // for renames\n       status: FileStatus,  // modified, added, deleted, renamed\n       additions: usize,\n       deletions: usize,\n       hunks: Vec<Hunk>,\n   }\n   \n   #[derive(Serialize)]\n   struct Hunk {\n       old_start: u32,\n       old_lines: u32,\n       new_start: u32,\n       new_lines: u32,\n       header: String,\n       changes: Vec<LineChange>,\n   }\n   \n   #[derive(Serialize)]\n   struct LineChange {\n       change_type: ChangeType,  // context, add, delete\n       line: String,\n   }\n   ```\n\n3. **Output Modes**\n   - Default: Standard unified diff format\n   - `--json`: Full structured output with hunks\n   - `--json --stat`: Summary only (fast)\n   - `--json --name-only`: Just file paths\n\n4. **Performance Optimization**\n   - Lazy hunk parsing (skip if --stat only)\n   - Streaming for large diffs\n   - Limit line context to Â±3 lines by default\n\n5. **Edge Cases**\n   - Binary files: include in files array but no hunks\n   - Renames: show old_path and new_path\n   - New files: status=\"added\", no old content\n   - Deleted files: status=\"deleted\", no new content\n\n## Testing Strategy\n- Unit tests: diff parsing, JSON serialization\n- Integration tests:\n  - Simple file modification\n  - Multiple files changed\n  - File rename detection\n  - Binary files\n  - Large diffs (performance)\n  - Staged vs unstaged\n  - Commit ranges\n- Error cases: invalid refs, permission errors\n\n## Documentation\n- Add to docs/AI_AGENT_GIT.md\n- JSON schema reference\n- Common AI agent patterns:\n  - Commit message generation\n  - Code review analysis\n  - Change summarization\n- Performance guide\n\n## Dependencies\n- git2-rs crate\n- serde_json\n- Extends GitContext\n\n## Estimated Effort\n50-60k tokens:\n- Implementation: 25k (more complex than git_log)\n- Tests: 20k (many edge cases)\n- Documentation: 10k\n- Debugging: 5k"
labels:
- ai-agents
- builtin
- critical
- git
- json
- p0
