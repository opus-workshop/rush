id: '164'
title: 'FOUNDATION-009: Command substitution in strings'
status: open
priority: 2
created_at: 2026-01-30T18:49:25.334985Z
updated_at: 2026-01-30T18:49:25.334985Z
description: "## Problem\nCommand substitution inside double-quoted strings doesn't expand.\n\n## Current Behavior\n```bash\necho \"dir: $(pwd)\"    # Output: dir: $(pwd)  (literal)\nx=\"$(echo foo)\"       # x contains literal $(echo foo)\n```\n\n## Expected Behavior\n```bash\necho \"dir: $(pwd)\"    # Output: dir: /current/path\nx=\"$(echo foo)\"; echo $x  # Output: foo\necho \"nested: $(echo $(echo deep))\"  # Output: nested: deep\n```\n\n## Implementation\n1. When parsing double-quoted strings, recognize `$(...)` sequences\n2. Execute the command inside substitution\n3. Capture stdout and insert into string\n4. Handle nested substitutions\n5. Also support backtick syntax: `cmd`\n\n## Test Cases\n```bash\ntest_case \"simple subst\" 'echo $(echo hello)' 'hello'\ntest_case \"subst in string\" 'echo \"dir: $(pwd)\"' \"dir: $(pwd)\"\ntest_case \"nested subst\" 'echo $(echo $(echo deep))' 'deep'\ntest_case \"subst in var\" 'x=$(echo foo); echo $x' 'foo'\n```\n\nNotes from dependencies:\nNo dependency notes (this bead depends only on the parent epic).\n\n## Implementation Notes (rush-onx.9)\n\n### What was done\nImplemented expansion of $(...) and backtick command substitutions inside double-quoted strings and literal arguments. The core fix is a new method `expand_command_substitutions_in_string` that scans a string for $() and backtick patterns, extracts the command, executes it via execute_command_substitution, and splices the output back into the string.\n\n### Files changed\n- **src/executor/mod.rs**: \n  - `resolve_argument()`: Argument::Literal now checks for $() or backtick and calls expand_command_substitutions_in_string\n  - `expand_string_value()`: Now handles embedded command substitutions (used for prefix env values)\n  - `evaluate_expression()`: Added match arm for Expression::Literal containing $() or backtick\n  - `resolve_argument_static()`: Same expansion for parallel execution path\n  - New method: `expand_command_substitutions_in_string(&self, input: &str) -> Result<String>` - instance method for &self Executor contexts\n  - New function: `pub(crate) fn expand_command_substitutions_in_string_static(input: &str, runtime: &Runtime) -> String` - free function for pipeline/parallel contexts\n- **src/executor/pipeline.rs**: Pipeline's `resolve_argument()` now expands command substitutions in Argument::Literal via the static function\n- **tests/command_substitution_tests.rs**: 5 new tests covering substitution in double-quoted strings, multiple substitutions, assignment values, pwd, and nested substitutions\n\n### Key design decisions\n- Expansion happens at the executor level (not lexer/parser) since it requires command execution\n- Parenthesis nesting is tracked to correctly handle nested $() like $(echo $(echo deep))\n- Single-quoted and double-quoted strings inside the command are skipped during paren matching\n- Backtick syntax supported alongside $()\n- Both instance method and static function variants to support all execution paths"
