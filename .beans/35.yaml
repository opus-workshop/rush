id: '35'
title: 'AI-003: Extend git_status with --json and full file listing'
status: open
priority: 1
created_at: 2026-01-30T18:49:24.431806Z
updated_at: 2026-01-30T18:49:24.431806Z
description: |-
  As an AI coding agent, I need git_status to return complete file listings and support JSON output so I can understand repository state without parsing text.

  ## Priority: P0 - CRITICAL
  Git status is called on almost every agent action to understand what files have changed.

  ## Acceptance Criteria
  - [ ] Extend existing src/builtins/git_status.rs
  - [ ] `git_status --json` returns structured JSON
  - [ ] Include all file categories: staged, unstaged, untracked
  - [ ] Include ahead/behind counts
  - [ ] Include current branch and tracking info
  - [ ] Include merge/rebase state if applicable
  - [ ] `git_status --json --porcelain` machine-readable format
  - [ ] Performance: <5ms on repos with <1000 files
  - [ ] Handle submodules gracefully
  - [ ] cargo test passes
  - [ ] cargo build --release succeeds
  - [ ] cargo clippy -- -D warnings passes

  ## Use Cases
  ```bash
  # AI agent: Get full repository state
  git_status --json
  # Returns:
  # {
  #   "branch": "feature/auth",
  #   "tracking": "origin/feature/auth",
  #   "ahead": 2,
  #   "behind": 0,
  #   "state": "clean",  // or "merge", "rebase", "cherry-pick"
  #   "staged": [
  #     {"path": "src/auth.rs", "status": "modified"},
  #     {"path": "tests/auth_test.rs", "status": "added"}
  #   ],
  #   "unstaged": [
  #     {"path": "src/main.rs", "status": "modified"},
  #     {"path": "README.md", "status": "modified"}
  #   ],
  #   "untracked": [
  #     "temp.txt",
  #     "debug.log"
  #   ],
  #   "conflicted": [],
  #   "summary": {
  #     "staged_count": 2,
  #     "unstaged_count": 2,
  #     "untracked_count": 2,
  #     "conflicted_count": 0
  #   }
  # }

  # AI agent: Quick check if repo is dirty
  git_status --json --porcelain | jq -r '.summary.unstaged_count'

  # Human: normal output (existing behavior)
  git_status
  ```

  ## Current State Analysis
  Looking at src/builtins/git_status.rs:61-68:
  ```rust
  if git_ctx.is_dirty() {
      output.push_str("Changes not staged for commit:\n");
      // TODO: List actual changed files
  } else {
      output.push_str("nothing to commit, working tree clean\n");
  }
  ```

  **This TODO is what we're implementing!**

  ## Technical Implementation
  1. **Extend GitContext (src/git.rs)**
     - Add methods:
       - `staged_files() -> Vec<(PathBuf, Status)>`
       - `unstaged_files() -> Vec<(PathBuf, Status)>`
       - `untracked_files() -> Vec<PathBuf>`
       - `conflicted_files() -> Vec<PathBuf>`
     - Use git2::Repository::statuses()

  2. **Update src/builtins/git_status.rs**
     - Add --json flag parsing
     - Implement JSON serialization
     - Fix the TODO: actually list files in human output
     - Add file status details

  3. **Data Structure**
     ```rust
     #[derive(Serialize)]
     struct GitStatusOutput {
         branch: Option<String>,
         tracking: Option<String>,
         ahead: u32,
         behind: u32,
         state: RepoState,  // clean, merge, rebase, etc.
         staged: Vec<FileStatus>,
         unstaged: Vec<FileStatus>,
         untracked: Vec<String>,
         conflicted: Vec<String>,
         summary: StatusSummary,
     }
     ```

  4. **Output Modes**
     - Default: Enhanced human-readable (list actual files!)
     - `--json`: Full structured output
     - `--porcelain`: Git-compatible machine format

  5. **Performance**
     - Cache status results in GitContext
     - Lazy loading of file lists
     - Ignore rules respected (.gitignore)

  ## Testing Strategy
  - Unit tests: status categorization, JSON serialization
  - Integration tests:
    - Clean repo
    - Staged files only
    - Unstaged files only
    - Mixed state
    - Untracked files
    - Merge conflicts
    - Ahead/behind tracking
  - Performance: benchmark on large repos

  ## Documentation
  - Update existing git_status docs
  - Add JSON schema
  - Add AI agent examples
  - Document performance characteristics

  ## Dependencies
  - Extends existing git_status.rs and GitContext
  - git2-rs (already in use)
  - serde_json

  ## Estimated Effort
  35-45k tokens:
  - GitContext extension: 10k
  - git_status update: 15k
  - Tests: 12k
  - Documentation: 8k
labels:
- ai-agents
- builtin
- critical
- git
- json
- p0
