id: '37'
title: 'AI-005: Add --json flag to ls builtin'
status: open
priority: 2
created_at: 2026-01-30T18:49:24.441663Z
updated_at: 2026-01-30T18:49:24.441663Z
description: "As an AI coding agent, I need ls to output structured JSON so I can process file listings programmatically without parsing text columns.\n\n## Priority: P1 - HIGH\nLs is one of the most-called commands by AI agents. Text parsing is fragile (spaces in filenames, different ls implementations).\n\n## Acceptance Criteria\n- [ ] Extend existing src/builtins/ls.rs\n- [ ] `ls --json` returns JSON array of file objects\n- [ ] Include: name, path, size, modified, type, permissions\n- [ ] `ls --json -l` includes full metadata\n- [ ] `ls --json -R` recursive directory tree\n- [ ] Handle symlinks: include target info\n- [ ] Handle errors gracefully (permission denied, etc.)\n- [ ] Performance: <5ms for <1000 files\n- [ ] Works with all existing ls flags (filter, sort)\n- [ ] cargo test passes\n- [ ] cargo build --release succeeds\n- [ ] cargo clippy -- -D warnings passes\n\n## Use Cases\n```bash\n# AI agent: Get file listing with metadata\nls --json src/\n# [\n#   {\n#     \"name\": \"main.rs\",\n#     \"path\": \"src/main.rs\",\n#     \"type\": \"file\",\n#     \"size\": 4523,\n#     \"modified\": \"2026-01-24T12:00:00Z\",\n#     \"permissions\": \"rw-r--r--\",\n#     \"mode\": 420\n#   },\n#   {\n#     \"name\": \"lib.rs\",\n#     \"path\": \"src/lib.rs\",\n#     \"type\": \"file\",\n#     \"size\": 1234,\n#     \"modified\": \"2026-01-23T10:30:00Z\",\n#     \"permissions\": \"rw-r--r--\",\n#     \"mode\": 420\n#   },\n#   {\n#     \"name\": \"builtins\",\n#     \"path\": \"src/builtins\",\n#     \"type\": \"directory\",\n#     \"size\": 4096,\n#     \"modified\": \"2026-01-24T11:00:00Z\",\n#     \"permissions\": \"rwxr-xr-x\",\n#     \"mode\": 493\n#   }\n# ]\n\n# AI agent: Find large files\nls --json -R | json_query '.[] | select(.size > 1000000)'\n\n# AI agent: Get just Rust files with metadata\nls --json src/*.rs\n\n# AI agent: Check if file exists and get size\nls --json file.txt | json_get '.[0].size'\n\n# Human: normal ls (existing behavior)\nls -la\n```\n\n## Current State Analysis\nLooking at existing ls.rs, it already:\n- Handles color output\n- Sorts files\n- Shows hidden files\n- Long format (-l)\n\nWe need to add:\n- JSON output mode\n- Structured metadata\n- Recursive JSON tree\n\n## Technical Implementation\n1. **Extend src/builtins/ls.rs**\n   - Add --json flag parsing\n   - Add OutputFormat enum (Human | Json)\n   - Extract metadata collection into separate function\n   - Implement JSON serialization\n\n2. **Data Structure**\n   ```rust\n   #[derive(Serialize)]\n   struct FileEntry {\n       name: String,\n       path: PathBuf,\n       file_type: FileType,  // file, directory, symlink\n       size: u64,\n       modified: String,  // ISO 8601\n       modified_timestamp: i64,\n       permissions: String,  // \"rw-r--r--\"\n       mode: u32,  // Unix mode bits\n       #[serde(skip_serializing_if = \"Option::is_none\")]\n       symlink_target: Option<PathBuf>,\n       #[serde(skip_serializing_if = \"Option::is_none\")]\n       owner: Option<String>,  // Unix only\n       #[serde(skip_serializing_if = \"Option::is_none\")]\n       group: Option<String>,  // Unix only\n   }\n   \n   #[derive(Serialize)]\n   enum FileType {\n       File,\n       Directory,\n       Symlink,\n       Other,\n   }\n   ```\n\n3. **Output Modes**\n   - Default: Current human-readable format (no changes)\n   - `--json`: JSON array of FileEntry objects\n   - `--json -l`: Include owner/group if available\n   - `--json -R`: Nested structure with children arrays\n\n4. **Recursive Structure**\n   ```rust\n   #[derive(Serialize)]\n   struct DirectoryEntry {\n       name: String,\n       path: PathBuf,\n       // ... other fields ...\n       #[serde(skip_serializing_if = \"Option::is_none\")]\n       children: Option<Vec<DirectoryEntry>>,\n   }\n   ```\n\n5. **Error Handling**\n   - Permission denied: include error in entry\n   - Broken symlinks: include in output with target=null\n   - Invalid UTF-8: use lossy conversion\n\n## Performance Optimization\n- Parallel metadata collection for large directories\n- Lazy stat() calls (only when needed)\n- Limit recursive depth to prevent stack overflow\n\n## Testing Strategy\n- Unit tests: metadata extraction, JSON serialization\n- Integration tests:\n  - Simple directory\n  - Recursive listing\n  - Symlinks\n  - Permission errors\n  - Empty directory\n  - Large directory (performance)\n- Cross-platform: Windows vs Unix permissions\n\n## Documentation\n- Update existing ls docs\n- Add JSON schema reference\n- Add AI agent examples\n- Document performance characteristics\n- Create docs/AI_AGENT_FILES.md\n\n## Dependencies\n- Extends existing ls.rs\n- serde_json\n- No new external crates needed\n\n## Estimated Effort\n35-45k tokens:\n- Implementation: 15k\n- Recursive support: 10k\n- Tests: 12k\n- Documentation: 8k"
labels:
- ai-agents
- builtin
- enhancement
- json
- p1
