id: '67'
title: Persistent Worker Process Pool
status: open
priority: 1
created_at: 2026-01-30T18:49:24.609296Z
updated_at: 2026-01-30T18:49:24.609296Z
description: "Replace fork-per-request with persistent worker pool to eliminate process creation overhead.\n\n## Priority: P0 - CRITICAL\nBiggest performance win. Core architectural fix.\n\n## Current Implementation\n- Each client request triggers fork() in accept_connection()\n- Worker process created, executes command, exits\n- Wasteful: full process creation + teardown per command\n- Overhead: ~2-3ms per request\n\n## Proposed Solution\nMaintain a pool of long-lived worker processes:\n- Pre-spawn N workers at daemon startup (N=4-8)\n- Workers listen on internal channels for requests\n- Dispatch requests to available workers\n- Workers reset state between requests (chdir, env vars)\n- Monitor worker health, respawn if needed\n\n## Architecture\n```rust\nstruct WorkerPool {\n    workers: Vec<Worker>,\n    request_queue: mpsc::Sender<SessionRequest>,\n    available: Arc<AtomicUsize>,\n}\n\nstruct Worker {\n    pid: Pid,\n    channel: UnixStream,\n    state: WorkerState,\n}\n```\n\n## Acceptance Criteria\n- [ ] WorkerPool struct created in src/daemon/worker_pool.rs\n- [ ] Pre-spawn 4-8 workers at daemon startup\n- [ ] Request dispatching to available workers\n- [ ] Worker state reset between requests (cwd, env, executor)\n- [ ] Worker health monitoring and auto-respawn\n- [ ] Graceful worker shutdown on daemon exit\n- [ ] All existing tests pass\n- [ ] New worker pool tests added\n- [ ] Benchmark shows 2-3ms improvement\n- [ ] cargo test passes\n- [ ] cargo build --release succeeds\n\n## Implementation Steps\n1. Create src/daemon/worker_pool.rs\n2. Design Worker struct with persistent state\n3. Implement worker spawn/manage/retire logic\n4. Add request queue/dispatch mechanism\n5. Implement state reset between requests\n6. Add health monitoring\n7. Update server.rs to use worker pool\n8. Update tests\n9. Benchmark\n\n## Files Created\n- src/daemon/worker_pool.rs (~200 LOC)\n\n## Files Modified  \n- src/daemon/server.rs (~100 LOC changes)\n- src/daemon/mod.rs (exports)\n\n## Challenges\n- State isolation between requests\n- Detecting worker hangs/crashes\n- Balancing pool size vs memory\n- Handling worker backpressure\n\n## Testing\n- Worker spawn/shutdown\n- Request dispatching\n- State reset verification\n- Worker failure recovery\n- Concurrent request handling\n- Load testing\n\n## Estimated Effort\n4-6 hours\n\n## Expected Speedup\n2-3ms reduction in daemon overhead (biggest win)"
labels:
- architecture
- critical
- daemon
- performance
