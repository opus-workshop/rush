id: '1.9'
title: Pi RPC Subprocess Manager
slug: pi-rpc-subprocess-manager
status: closed
priority: 1
created_at: 2026-02-03T08:47:47.411122Z
updated_at: 2026-02-03T08:54:04.045459Z
description: "Manage pi as a long-lived subprocess in RPC mode for fast `|?` execution.\n\n## Approach\n\nInstead of a custom Unix socket daemon, Rush spawns `pi --rpc` as a subprocess and keeps it running. This reuses Pi's existing battle-tested RPC protocol.\n\n## New File: `src/daemon/pi_rpc.rs`\n\n```rust\nuse std::process::{Child, Command, Stdio};\nuse std::io::{BufRead, BufReader, Write};\nuse serde::{Deserialize, Serialize};\n\n/// Pi RPC command (subset we need)\n#[derive(Serialize)]\n#[serde(tag = \"type\")]\npub enum PiCommand {\n    #[serde(rename = \"prompt\")]\n    Prompt {\n        id: String,\n        message: String,\n    },\n}\n\n/// Pi RPC events we care about\n#[derive(Deserialize)]\n#[serde(tag = \"type\")]\npub enum PiEvent {\n    #[serde(rename = \"content_delta\")]\n    ContentDelta { content: String },\n    #[serde(rename = \"agent_end\")]\n    AgentEnd {},\n    #[serde(rename = \"error\")]\n    Error { message: String },\n    // ... other events we can ignore\n}\n\npub struct PiRpcManager {\n    process: Option<Child>,\n    stdin: Option<std::process::ChildStdin>,\n    stdout_reader: Option<BufReader<std::process::ChildStdout>>,\n}\n\nimpl PiRpcManager {\n    pub fn new() -> Self {\n        Self { process: None, stdin: None, stdout_reader: None }\n    }\n    \n    /// Ensure pi subprocess is running\n    pub fn ensure_running(&mut self) -> Result<(), PiError> {\n        if self.process.is_some() {\n            return Ok(());\n        }\n        \n        let mut child = Command::new(\"pi\")\n            .arg(\"--rpc\")\n            .stdin(Stdio::piped())\n            .stdout(Stdio::piped())\n            .stderr(Stdio::null())\n            .spawn()?;\n        \n        self.stdin = child.stdin.take();\n        self.stdout_reader = Some(BufReader::new(child.stdout.take().unwrap()));\n        self.process = Some(child);\n        Ok(())\n    }\n    \n    /// Send prompt and stream responses\n    pub fn prompt(&mut self, message: &str) -> Result<impl Iterator<Item = PiEvent>, PiError> {\n        self.ensure_running()?;\n        \n        let cmd = PiCommand::Prompt {\n            id: uuid::Uuid::new_v4().to_string(),\n            message: message.to_string(),\n        };\n        \n        // Send command\n        let stdin = self.stdin.as_mut().unwrap();\n        serde_json::to_writer(&mut *stdin, &cmd)?;\n        writeln!(stdin)?;\n        stdin.flush()?;\n        \n        // Return iterator over responses\n        Ok(PiEventIterator { reader: self.stdout_reader.as_mut().unwrap() })\n    }\n}\n```\n\n## Integration with Executor\n\n```rust\n// In executor, maintain a PiRpcManager\nimpl Executor {\n    fn get_pi_rpc(&mut self) -> &mut PiRpcManager {\n        self.pi_rpc.get_or_insert_with(PiRpcManager::new)\n    }\n}\n```\n\n## Graceful Shutdown\n\n- On rush exit, send SIGTERM to pi subprocess\n- Implement Drop for PiRpcManager to clean up"
closed_at: 2026-02-03T08:54:04.045459Z
close_reason: |-
  Implemented PiRpcManager in src/daemon/pi_rpc.rs with:
  - PiRpcError enum for comprehensive error handling
  - PiCommand enum (Prompt variant) for sending commands to Pi
  - PiEvent enum (ContentDelta, AgentEnd, Error, Ready, Unknown) for receiving responses
  - PiRpcManager struct with process/stdin/stdout_reader fields
  - ensure_running() method to spawn pi --rpc subprocess
  - is_running() method to check subprocess health
  - prompt() method returning PiEventIterator for streaming responses
  - prompt_blocking() convenience method for collecting full response
  - stop() method with graceful SIGTERM then force kill
  - Drop implementation for automatic cleanup
  - PiEventIterator for streaming event iteration
  - Comprehensive unit tests for serialization, deserialization, and error handling
  - Updated mod.rs to export new module and types
parent: '1'
verify: grep -q "pub struct PiRpcManager" src/daemon/pi_rpc.rs && grep -q "ensure_running" src/daemon/pi_rpc.rs && cargo check 2>&1 | grep -v "^warning"
claimed_at: 2026-02-03T08:52:24.641751Z
is_archived: true
produces:
- pi_rpc_manager
