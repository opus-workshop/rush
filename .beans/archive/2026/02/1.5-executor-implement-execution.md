id: '1.5'
title: 'Executor: Implement `|?` execution'
slug: executor-implement-execution
status: closed
priority: 1
created_at: 2026-02-03T08:38:26.281738Z
updated_at: 2026-02-03T09:12:12.688638Z
description: "Execute the `|?` operator by capturing command output and sending to Pi.\n\n## File: `src/executor/mod.rs`\n\nAdd handler for PipeAsk AST node:\n\n```rust\nimpl Executor {\n    fn execute_pipe_ask(&mut self, pipe_ask: &PipeAsk) -> Result<i32> {\n        // 1. Execute the command and capture stdout\n        let output = self.execute_capture(&pipe_ask.command)?;\n        \n        // 2. Build shell context\n        let context = ShellContext {\n            cwd: std::env::current_dir()?.to_string_lossy().to_string(),\n            last_command: self.last_command.clone(),\n            last_exit_code: self.last_exit_code,\n            history: self.history.recent(10),\n            env: self.selected_env_vars(),\n        };\n        \n        // 3. Connect to Pi (or use cached connection)\n        let mut client = self.get_pi_client()?;\n        \n        // 4. Send query with streaming response\n        let responses = client.query(&pipe_ask.prompt, Some(&output), context)?;\n        \n        // 5. Stream output to terminal\n        for response in responses {\n            match response {\n                PiToRush::Chunk { content, .. } => {\n                    print!(\"{}\", content);\n                    std::io::stdout().flush()?;\n                }\n                PiToRush::Done { .. } => {\n                    println!();\n                    break;\n                }\n                PiToRush::Error { message, .. } => {\n                    eprintln!(\"AI error: {}\", message);\n                    return Ok(1);\n                }\n                PiToRush::ToolCall { .. } => {\n                    // Handle Pi requesting command execution\n                    self.handle_pi_tool_call(&mut client, response)?;\n                }\n            }\n        }\n        \n        Ok(0)\n    }\n}\n```\n\n## Fallback Behavior\nIf Pi daemon is not running:\n- Print helpful message: \"Pi daemon not running. Start with: pi daemon start\"\n- Or fall back to a simple curl to Anthropic API if ANTHROPIC_API_KEY is set"
closed_at: 2026-02-03T09:12:12.688638Z
close_reason: 'Auto-closed: all children completed'
parent: '1'
verify: grep -q "execute_pipe_ask\|PipeAsk" src/executor/mod.rs && cargo check 2>&1 | grep -v "^warning"
is_archived: true
produces:
- executor_pipe_ask
requires:
- parser_pipe_ask
- pi_client
