id: '1.1'
title: IPC Protocol Types
slug: ipc-protocol-types
status: closed
priority: 1
created_at: 2026-02-03T08:38:26.072383Z
updated_at: 2026-02-03T08:40:24.623714Z
description: "Define the message protocol for Rush ↔ Pi communication.\n\n## New File: `src/daemon/protocol.rs`\n\n```rust\nuse serde::{Deserialize, Serialize};\n\n/// Shell context passed with every query\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct ShellContext {\n    pub cwd: String,\n    pub last_command: Option<String>,\n    pub last_exit_code: Option<i32>,\n    pub history: Vec<String>,  // Last N commands\n    pub env: HashMap<String, String>,  // Selected env vars\n}\n\n/// Rush → Pi messages\n#[derive(Debug, Serialize, Deserialize)]\n#[serde(tag = \"type\")]\npub enum RushToPi {\n    /// Query the LLM\n    #[serde(rename = \"query\")]\n    Query {\n        id: String,\n        prompt: String,\n        stdin: Option<String>,\n        context: ShellContext,\n    },\n    /// Response to a tool call\n    #[serde(rename = \"tool_result\")]\n    ToolResult {\n        id: String,\n        output: String,\n        exit_code: i32,\n    },\n}\n\n/// Pi → Rush messages  \n#[derive(Debug, Serialize, Deserialize)]\n#[serde(tag = \"type\")]\npub enum PiToRush {\n    /// Streaming content chunk\n    #[serde(rename = \"chunk\")]\n    Chunk { id: String, content: String },\n    /// Stream complete\n    #[serde(rename = \"done\")]\n    Done { id: String },\n    /// Error occurred\n    #[serde(rename = \"error\")]\n    Error { id: String, message: String },\n    /// Pi wants to run a command\n    #[serde(rename = \"tool_call\")]\n    ToolCall {\n        id: String,\n        tool: String,\n        args: serde_json::Value,\n    },\n}\n```\n\n## Wire Format\n- Newline-delimited JSON (JSONL)\n- Each message is one line\n- UTF-8 encoded"
closed_at: 2026-02-03T08:40:24.623714Z
close_reason: |-
  Added Rush ↔ Pi IPC protocol types to protocol.rs:
  - ShellContext struct with cwd, last_command, last_exit_code, history, env
  - RushToPi enum with Query and ToolResult variants (tagged with "type" field)
  - PiToRush enum with Chunk, Done, Error, and ToolCall variants
  - encode_jsonl() and decode_jsonl() helper functions for JSONL wire format
  - Comprehensive tests for all message types and round-trip serialization
  - Updated module documentation to describe both protocols
parent: '1'
verify: grep -q "pub enum RushToPi" src/daemon/protocol.rs && grep -q "pub enum PiToRush" src/daemon/protocol.rs && cargo check 2>&1 | grep -v "^warning"
claimed_at: 2026-02-03T08:39:03.140691Z
is_archived: true
produces:
- protocol
