id: '1.4'
title: 'Pi Client: Unix socket connection'
slug: pi-client-unix-socket-connection
status: closed
priority: 1
created_at: 2026-02-03T08:38:26.228360Z
updated_at: 2026-02-03T08:43:20.497080Z
description: "Create a client that connects to Pi daemon over Unix socket.\n\n## New File: `src/daemon/pi_client.rs`\n\n```rust\nuse std::os::unix::net::UnixStream;\nuse std::io::{BufRead, BufReader, Write};\nuse crate::daemon::protocol::{RushToPi, PiToRush, ShellContext};\n\npub struct PiClient {\n    stream: UnixStream,\n    reader: BufReader<UnixStream>,\n}\n\nimpl PiClient {\n    /// Connect to Pi daemon\n    /// Tries: $RUSH_PI_SOCKET, ~/.pi/rush.sock, /tmp/pi-rush.sock\n    pub fn connect() -> Result<Self, PiClientError> {\n        let socket_path = Self::find_socket()?;\n        let stream = UnixStream::connect(&socket_path)?;\n        // ...\n    }\n    \n    /// Send a query and return a streaming response iterator\n    pub fn query(\n        &mut self,\n        prompt: &str,\n        stdin: Option<&str>,\n        context: ShellContext,\n    ) -> Result<impl Iterator<Item = PiToRush>, PiClientError> {\n        let msg = RushToPi::Query {\n            id: uuid::Uuid::new_v4().to_string(),\n            prompt: prompt.to_string(),\n            stdin: stdin.map(String::from),\n            context,\n        };\n        self.send(&msg)?;\n        Ok(self.stream_responses())\n    }\n    \n    /// Handle a tool call from Pi (bidirectional)\n    pub fn handle_tool_call(&mut self, call: ToolCall) -> Result<(), PiClientError> {\n        // Execute the command and send result back\n    }\n}\n```\n\n## Socket Discovery\n1. `$RUSH_PI_SOCKET` environment variable\n2. `~/.pi/rush.sock`\n3. `/tmp/pi-rush-$USER.sock`\n\n## Error Handling\n- `PiClientError::NotRunning` - Pi daemon not found\n- `PiClientError::ConnectionFailed` - Socket exists but can't connect\n- `PiClientError::ProtocolError` - Invalid message format"
closed_at: 2026-02-03T08:43:20.497080Z
close_reason: Implemented PiClient with Unix socket connection, socket discovery (RUSH_PI_SOCKET, ~/.pi/rush.sock, /tmp/pi-rush-$USER.sock), query streaming, and tool call handling
parent: '1'
verify: grep -q "pub struct PiClient" src/daemon/pi_client.rs && grep -q "pub fn connect" src/daemon/pi_client.rs && cargo check 2>&1 | grep -v "^warning"
claimed_at: 2026-02-03T08:41:56.636200Z
is_archived: true
produces:
- pi_client
requires:
- protocol
