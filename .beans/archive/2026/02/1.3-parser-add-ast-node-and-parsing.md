id: '1.3'
title: 'Parser: Add `|?` AST node and parsing'
slug: parser-add-ast-node-and-parsing
status: closed
priority: 1
created_at: 2026-02-03T08:38:26.176694Z
updated_at: 2026-02-03T09:08:49.865290Z
description: "Parse `|?` operator into AST.\n\n## File: `src/parser/ast.rs` (or wherever AST is defined)\n\nAdd new AST variant:\n```rust\n/// A command that pipes to AI\n#[derive(Debug, Clone)]\npub struct PipeAsk {\n    /// The command whose output to send\n    pub command: Box<Command>,\n    /// The prompt for the AI\n    pub prompt: String,\n}\n```\n\n## File: `src/parser/mod.rs`\n\nParse `|?` in pipeline context:\n```rust\n// When we see PipeAsk token after a command:\n// cmd |? \"prompt\"\n// \n// The prompt can be:\n// - A quoted string: |? \"write a commit message\"\n// - A word: |? summarize\n// - Omitted (use default): |?  (just sends stdin to AI)\n```\n\n## Test Cases\n```rust\n#[test]\nfn test_parse_pipe_ask() {\n    let ast = parse(\"echo hello |? \\\"summarize\\\"\").unwrap();\n    // Verify AST contains PipeAsk node\n}\n\n#[test]\nfn test_parse_pipe_ask_in_pipeline() {\n    let ast = parse(\"cat file.txt | grep error |? \\\"explain these errors\\\"\").unwrap();\n    // Should work in middle/end of pipeline\n}\n```"
closed_at: 2026-02-03T09:08:49.865290Z
close_reason: "Added PipeAsk AST node and parsing support:\n\n1. Added `PipeAsk` struct to `src/parser/ast.rs` with `command` (Box<Statement>) and `prompt` (String) fields\n2. Added `Statement::PipeAsk` variant to the Statement enum\n3. Modified `parse_command_or_pipeline` to check for `|?` after parsing commands/pipelines and wrap them in `PipeAsk`\n4. Added `parse_pipe_ask_prompt` method to handle quoted strings, unquoted words, or empty prompts\n5. Added `Token::PipeAsk` to command termination conditions in `parse_command`\n6. Added placeholder `execute_pipe_ask` in executor (returns \"not yet implemented\" error)\n7. Added `PipeAsk` handling in compat/analyzer.rs\n\nAll 5 test cases pass:\n- test_parse_pipe_ask_simple\n- test_parse_pipe_ask_in_pipeline\n- test_parse_pipe_ask_no_prompt  \n- test_parse_pipe_ask_unquoted_prompt\n- test_parse_pipe_ask_single_quoted_prompt"
parent: '1'
verify: cargo test --lib parser -- pipe_ask --test-threads=1 2>&1 | grep -E "(test.*ok|PASSED|passed)"
claimed_at: 2026-02-03T09:04:46.824338Z
is_archived: true
produces:
- parser_pipe_ask
requires:
- lexer_pipe_ask
