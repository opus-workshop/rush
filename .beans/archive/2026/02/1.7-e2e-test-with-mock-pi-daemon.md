id: '1.7'
title: 'E2E Test: `|?` with mock Pi daemon'
slug: e2e-test-with-mock-pi-daemon
status: closed
priority: 1
created_at: 2026-02-03T08:38:48.155521Z
updated_at: 2026-02-03T08:48:28.552553Z
description: "Create end-to-end tests for the `|?` operator using a mock Pi daemon.\n\n## New File: `tests/pipe_ask_tests.rs`\n\n```rust\nuse std::os::unix::net::UnixListener;\nuse std::thread;\n\n/// Spawn a mock Pi daemon that echoes back a canned response\nfn spawn_mock_pi_daemon(socket_path: &str) -> thread::JoinHandle<()> {\n    let listener = UnixListener::bind(socket_path).unwrap();\n    thread::spawn(move || {\n        for stream in listener.incoming() {\n            let mut stream = stream.unwrap();\n            // Read query, send mock streaming response\n            // {\"type\":\"chunk\",\"id\":\"x\",\"content\":\"Hello \"}\n            // {\"type\":\"chunk\",\"id\":\"x\",\"content\":\"world!\"}\n            // {\"type\":\"done\",\"id\":\"x\"}\n        }\n    })\n}\n\n#[test]\nfn test_pipe_ask_basic() {\n    let socket = \"/tmp/test-pi-rush.sock\";\n    let _daemon = spawn_mock_pi_daemon(socket);\n    \n    // Run rush with |?\n    let output = Command::new(\"./target/debug/rush\")\n        .env(\"RUSH_PI_SOCKET\", socket)\n        .arg(\"-c\")\n        .arg(r#\"echo \"test\" |? \"respond\"\"#)\n        .output()\n        .unwrap();\n    \n    assert!(output.status.success());\n    assert!(String::from_utf8_lossy(&output.stdout).contains(\"Hello world!\"));\n}\n\n#[test]\nfn test_pipe_ask_streaming() {\n    // Verify output appears incrementally, not all at once\n}\n\n#[test]\nfn test_pipe_ask_no_daemon() {\n    // Verify helpful error when Pi daemon not running\n    let output = Command::new(\"./target/debug/rush\")\n        .env(\"RUSH_PI_SOCKET\", \"/nonexistent/socket\")\n        .arg(\"-c\")\n        .arg(r#\"echo \"test\" |? \"respond\"\"#)\n        .output()\n        .unwrap();\n    \n    assert!(!output.status.success());\n    assert!(String::from_utf8_lossy(&output.stderr).contains(\"Pi daemon not running\"));\n}\n\n#[test]\nfn test_pipe_ask_in_pipeline() {\n    // cat file | grep pattern |? \"explain\"\n}\n```"
closed_at: 2026-02-03T08:48:28.552553Z
close_reason: Superseded by bean 1.10 which uses mock pi subprocess instead of Unix socket daemon
parent: '1'
verify: cargo test --test pipe_ask_tests 2>&1 | grep -E "(test.*ok|passed|PASSED)"
attempts: 1
is_archived: true
requires:
- executor_pipe_ask
