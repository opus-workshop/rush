id: '211.7'
title: 'PARSER-BUG: Pipes into while/until/compound commands not supported'
slug: parser-bug-pipes-into-whileuntilcompound-commands
status: closed
priority: 1
created_at: 2026-02-02T04:41:06.522837Z
updated_at: 2026-02-02T07:11:24.546802Z
description: |-
  ## Problem
  Piping into compound commands (while, until, {...}) causes parse error.

  ## Reproduction
  ```bash
  echo hello | while read x; do echo "x=$x"; done  # FAILS
  echo hello | { read x; echo "x=$x"; }            # FAILS
  # Error: Expected command name
  ```

  ## Working alternative
  ```bash
  while read x; do echo $x; done < file.txt        # Works
  ```

  ## Expected
  Compound commands should be valid pipeline targets.

  ## Impact
  Many common shell patterns broken.
notes: "---\n2026-02-02T06:05:39.271312+00:00\nImplementation approach identified and code written but file edits not persisting properly. Key changes needed:\n\n1. AST (src/parser/ast.rs):\n   - Add BraceGroup(Vec<Statement>) to Statement enum  \n   - Add CompoundCommand(Box<Statement>) to PipelineElement enum\n\n2. Parser (src/parser/mod.rs):\n   - Modify parse_pipeline_element() to check for While/Until/For/If/Case/LeftBrace tokens\n   - Add parse_brace_group() method\n   - Add statement_to_pipeline_element() helper\n   - Update pipeline building to use helper\n\n3. Executor: Add CompoundCommand and BraceGroup handling\n\nThe implementation was completed multiple times but source files reverted.\n\n---\n2026-02-02T06:23:36.482355+00:00\nParser fix complete - compound commands (while/until/for/if/case/brace groups) now parse correctly after pipes.\n\nExample working: echo hello | while true; do echo got; break; done\n\nRemaining issue: Stdin not properly piped to compound commands. The 'read' builtin inside compound commands doesn't receive piped input. This is a separate executor issue affecting both subshells and compound commands.\n\n---\n2026-02-02T06:23:53.101853+00:00\nPARSER FIX COMPLETE - compound commands now parse correctly after pipes.\n\nEXECUTION FIX INCOMPLETE - stdin not piped to compound commands.\n\nChanges made:\n1. AST: Added BraceGroup statement, CompoundCommand pipeline element\n2. Parser: parse_pipeline_element now handles while/until/for/if/case/brace\n3. Executor: Added execute_brace_group and execute_compound_in_pipeline\n\nWhat works:\n- echo a | while true; do echo parsed; break; done  # Works!\n\nWhat doesn't work:\n- echo hello | while read x; do echo got-$x; done  # 'read' gets no input\n\nThe stdin piping issue affects BOTH subshells AND compound commands. This is a separate executor-level issue that needs additional work."
closed_at: 2026-02-02T07:11:24.546802Z
parent: '211'
verify: rush -c 'echo hello | while read x; do echo "got-$x"; done' | grep -q 'got-hello'
claimed_at: 2026-02-02T06:35:27.548247Z
is_archived: true
