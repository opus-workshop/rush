id: '1.10'
title: 'E2E Test: `|?` with mock pi RPC'
slug: e2e-test-with-mock-pi-rpc
status: closed
priority: 1
created_at: 2026-02-03T08:48:19.362415Z
updated_at: 2026-02-03T09:27:27.804203Z
description: "Create end-to-end tests for the `|?` operator using a mock pi subprocess.\n\n## Updated Approach\n\nInstead of mocking a Unix socket daemon, we mock the `pi --rpc` subprocess behavior.\n\n## New File: `tests/pipe_ask_tests.rs`\n\n```rust\nuse std::process::Command;\nuse std::io::Write;\nuse tempfile::NamedTempFile;\n\n/// Create a mock \"pi\" script that responds with canned RPC output\nfn create_mock_pi() -> NamedTempFile {\n    let mut file = NamedTempFile::new().unwrap();\n    writeln!(file, r#\"#!/bin/bash\n# Mock pi --rpc that echoes back streaming response\nwhile IFS= read -r line; do\n    # Parse the prompt command and respond\n    echo '{{\"type\":\"content_delta\",\"content\":\"Mock \"}}'\n    echo '{{\"type\":\"content_delta\",\"content\":\"response\"}}'\n    echo '{{\"type\":\"agent_end\"}}'\ndone\n\"#).unwrap();\n    \n    // Make executable\n    std::fs::set_permissions(file.path(), std::os::unix::fs::PermissionsExt::from_mode(0o755)).unwrap();\n    file\n}\n\n#[test]\nfn test_pipe_ask_basic() {\n    let mock_pi = create_mock_pi();\n    \n    // Run rush with mock pi in PATH\n    let output = Command::new(\"./target/debug/rush\")\n        .env(\"RUSH_PI_PATH\", mock_pi.path())  // Override pi binary location\n        .arg(\"-c\")\n        .arg(r#\"echo \"test\" |? \"respond\"\"#)\n        .output()\n        .unwrap();\n    \n    assert!(output.status.success());\n    assert!(String::from_utf8_lossy(&output.stdout).contains(\"Mock response\"));\n}\n\n#[test]\nfn test_pipe_ask_no_pi() {\n    // Verify helpful error when pi is not installed\n    let output = Command::new(\"./target/debug/rush\")\n        .env(\"RUSH_PI_PATH\", \"/nonexistent/pi\")\n        .env(\"PATH\", \"\")  // Clear PATH\n        .arg(\"-c\")\n        .arg(r#\"echo \"test\" |? \"respond\"\"#)\n        .output()\n        .unwrap();\n    \n    assert!(!output.status.success());\n    let stderr = String::from_utf8_lossy(&output.stderr);\n    assert!(stderr.contains(\"pi not found\") || stderr.contains(\"install pi\"));\n}\n\n#[test]\nfn test_pipe_ask_captures_stdin() {\n    // Verify the command output is passed to pi\n    let mock_pi = create_mock_pi();\n    \n    let output = Command::new(\"./target/debug/rush\")\n        .env(\"RUSH_PI_PATH\", mock_pi.path())\n        .arg(\"-c\")\n        .arg(r#\"echo \"hello world\" |? \"summarize\"\"#)\n        .output()\n        .unwrap();\n    \n    assert!(output.status.success());\n}\n\n#[test]\nfn test_pipe_ask_in_pipeline() {\n    // cat file | grep pattern |? \"explain\"\n    let mock_pi = create_mock_pi();\n    \n    let output = Command::new(\"./target/debug/rush\")\n        .env(\"RUSH_PI_PATH\", mock_pi.path())\n        .arg(\"-c\")\n        .arg(r#\"echo -e \"error: foo\\nwarning: bar\" | grep error |? \"explain\"\"#)\n        .output()\n        .unwrap();\n    \n    assert!(output.status.success());\n}\n```\n\n## Environment Variables\n- `RUSH_PI_PATH` - Override path to pi binary (for testing)\n- Falls back to finding `pi` in PATH"
closed_at: 2026-02-03T09:27:27.804203Z
close_reason: 'All 7 E2E tests for the |? operator pass: test_pipe_ask_basic, test_pipe_ask_no_pi, test_pipe_ask_captures_stdin, test_pipe_ask_in_pipeline, test_pipe_ask_empty_prompt, test_pipe_ask_single_quoted_prompt, test_pipe_ask_multiword_prompt'
parent: '1'
verify: cargo test --test pipe_ask_tests 2>&1 | grep -E "(test.*ok|passed|PASSED)"
claimed_at: 2026-02-03T09:27:11.493615Z
is_archived: true
requires:
- executor_pipe_ask
- pi_rpc_manager
